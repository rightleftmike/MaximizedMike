<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Daily Health Tracker</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  <style>
    :root { --bg:#0b1220; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0b1220 60%,#0e1426);color:var(--ink)}
    header{position:sticky;top:0;backdrop-filter:saturate(1.2) blur(8px);background:#0b1220cc;padding:12px 16px;border-bottom:1px solid #1f2937}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .g{display:grid;gap:12px}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:14px}
    button{background:#111827;border:1px solid #1f2937;color:var(--ink);padding:10px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent;color:#0b1220;font-weight:700}
    button.success{background:var(--ok);color:#08210f;border-color:transparent}
    input, select{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:10px;color:var(--ink);width:100%}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #334155;color:var(--muted)}
    .space{display:flex;justify-content:space-between;align-items:center}
    .muted{color:var(--muted)}
    .score{font-size:28px;font-weight:800}
    .calendar{display:flex;gap:8px;overflow:auto;padding-bottom:6px}
    .day{min-width:90px;text-align:center;padding:8px;border:1px solid #243047;border-radius:10px}
    .day.active{outline:2px solid var(--accent)}
    .task{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px;border:1px solid #243047;border-radius:10px}
    .task.done{border-color:#234f35;background:#0c1a12}
    .small{font-size:12px}
    .warn{color:var(--warn)}
    .g2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  </style>
</head>
<body>
<header class="container space">
  <div class="row">
    <strong>Daily Health Tracker</strong>
    <span id="userStatus" class="pill">Signed out</span>
  </div>
  <div class="row">
    <button id="anonBtn" class="primary">Start (Guest)</button>
    <button id="signOutBtn" class="pill" style="display:none">Sign out</button>
  </div>
</header>

<main class="container g">
  <!-- Calendar strip -->
  <section class="card g">
    <div class="space">
      <h3>Calendar</h3>
      <div class="muted small">Tap a day to edit ‚Ä¢ Week starts Monday</div>
    </div>
    <div id="calendar" class="calendar"></div>
  </section>

  <!-- Today / active day -->
  <section class="card g">
    <div class="space">
      <h3 id="dayTitle">Today</h3>
      <div class="row">
        <input id="weightInput" type="number" step="0.1" placeholder="Weight (lb)"/>
        <button id="saveWeight" class="success">Save weight</button>
      </div>
    </div>

    <div class="g">
      <!-- Meditation required daily (min +2) -->
      <div class="task" id="meditationBlock">
        <div>
          <strong>Meditation (required daily)</strong>
          <div class="small muted">Pick type + duration ‚Üí points (min +2)</div>
          <div class="g2" style="margin-top:6px">
            <select id="meditationType">
              <option>Gratitude</option>
              <option>Journaling</option>
              <option>Prayer</option>
              <option>Breathwork</option>
            </select>
            <select id="meditationDuration">
              <option value="lt15">&lt; 15 min (+2)</option>
              <option value="lt30">15‚Äì29 min (+3)</option>
              <option value="ge45">‚â• 45 min (+5)</option>
            </select>
          </div>
          <div id="meditationStatus" class="small" style="margin-top:6px"></div>
        </div>
        <button id="meditationDone" class="primary">Log</button>
      </div>

      <!-- Anchors -->
      <div class="task" data-key="smoothie_meal">
        <div><strong>Smoothie Meal</strong><div class="small muted">+2 pts when done</div></div>
        <button class="completeBtn">‚úì</button>
      </div>

      <!-- Movement -->
      <div class="task" data-key="walk_DEBS">
        <div><strong>DEBS Walk (~50 min)</strong><div class="small muted">Points auto from minutes</div></div>
        <div class="row">
          <input class="minutesInput" type="number" placeholder="mins"/>
          <button class="completeBtn">‚úì</button>
        </div>
      </div>

      <div class="task" data-key="yoga">
        <div><strong>Yoga (Slow Stretch)</strong><div class="small muted">Points auto from minutes</div></div>
        <div class="row">
          <input class="minutesInput" type="number" placeholder="mins"/>
          <button class="completeBtn">‚úì</button>
        </div>
      </div>

      <div class="task" data-key="weights">
        <div><strong>Weightlifting</strong><div class="small muted">1‚Äì2√ó/wk ‚Ä¢ Points from minutes</div></div>
        <div class="row">
          <input class="minutesInput" type="number" placeholder="mins"/>
          <button class="completeBtn">‚úì</button>
        </div>
      </div>

      <!-- Lifestyle -->
      <div class="task" data-key="alcohol">
        <div><strong>Alcohol</strong><div class="small muted">Enter # drinks today</div></div>
        <div class="row">
          <input class="drinksInput" type="number" min="0" step="1" placeholder="drinks"/>
          <button class="saveDrinksBtn">Save</button>
        </div>
      </div>
    </div>

    <div class="space" style="margin-top:6px">
      <div>Daily Points: <span id="dailyPoints" class="score">0</span></div>
      <div id="meditationReqNote" class="small warn">Meditation min +2 required daily.</div>
    </div>
  </section>

  <!-- Weekly tracker -->
  <section class="card g">
    <div class="space">
      <h3>Weekly Progress</h3>
      <div class="small muted">Tiers: ‚ùå &lt;60 ‚Ä¢ üéØ 60‚Äì79 ‚Ä¢ ‚≠ê 80‚Äì89 ‚Ä¢ üèÜ ‚â•90</div>
    </div>
    <div id="wkRange" class="small muted"></div>
    <div style="font-size:28px;margin-top:6px">Points: <b id="wkPoints">0</b></div>
    <div id="projLine" style="margin-top:6px"></div>
    <div id="dailyNeed" class="small muted"></div>
  </section>
</main>

<script type="module">
  /* ===== Firebase (modular SDKs) ===== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, enableIndexedDbPersistence, doc, setDoc, getDoc, onSnapshot,
    collection, getDocs, query, where, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // >>> REPLACE with your config from Firebase console
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  enableIndexedDbPersistence(db).catch(()=>{});

  /* ===== DOM ===== */
  const userStatus = document.getElementById('userStatus');
  const anonBtn = document.getElementById('anonBtn');
  const signOutBtn = document.getElementById('signOutBtn');
  const calendarEl = document.getElementById('calendar');
  const dayTitle = document.getElementById('dayTitle');
  const weightInput = document.getElementById('weightInput');
  const saveWeightBtn = document.getElementById('saveWeight');
  const dailyPointsEl = document.getElementById('dailyPoints');
  const meditationType = document.getElementById('meditationType');
  const meditationDuration = document.getElementById('meditationDuration');
  const meditationDoneBtn = document.getElementById('meditationDone');
  const meditationStatus = document.getElementById('meditationStatus');
  const meditationReqNote = document.getElementById('meditationReqNote');
  const wkRange = document.getElementById('wkRange');
  const wkPoints = document.getElementById('wkPoints');
  const projLine = document.getElementById('projLine');
  const dailyNeed = document.getElementById('dailyNeed');

  /* ===== Utils ===== */
  const todayISO = toISO(new Date());
  let activeDate = todayISO;
  let uid = null;
  let unsubDay = null;

  function toISO(d){ const z=new Date(d.getFullYear(),d.getMonth(),d.getDate()); return z.toISOString().slice(0,10); }
  function addDaysISO(iso,n){ const d=new Date(iso+"T00:00:00"); d.setDate(d.getDate()+n); return toISO(d); }
  function weekStart(iso){ const d=new Date(iso+"T00:00:00"); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); return toISO(d); }
  function humanRange(iso){ const ws=new Date(weekStart(iso)+"T00:00:00"); const we=new Date(ws); we.setDate(ws.getDate()+6); const o={month:'short',day:'numeric'}; return `${ws.toLocaleDateString(undefined,o)} ‚Äì ${we.toLocaleDateString(undefined,o)}`; }
  function pointsFromMinutes(min){ if(!min||min<=0) return 0; if(min<30) return 2; if(min<60) return 3; return 5; }
  function meditationPts(tag){ if(tag==='lt15') return 2; if(tag==='lt30') return 3; return 5; }

  /* ===== Auth ===== */
  anonBtn.onclick = async ()=>{ await signInAnonymously(auth); };
  signOutBtn.onclick = async ()=>{ await signOut(auth); };

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      uid = user.uid;
      userStatus.textContent = 'Signed in (guest)';
      anonBtn.style.display = 'none'; signOutBtn.style.display='inline-block';
      buildCalendar(); loadDay(activeDate); refreshWeek();
    } else {
      uid = null;
      userStatus.textContent = 'Signed out';
      anonBtn.style.display = 'inline-block'; signOutBtn.style.display='none';
    }
  });

  /* ===== Calendar ===== */
  function buildCalendar(){
    calendarEl.innerHTML='';
    for(let i=-6;i<=7;i++){
      const iso = addDaysISO(todayISO,i);
      const d = new Date(iso+"T00:00:00");
      const el = document.createElement('div');
      el.className = 'day'+(iso===activeDate?' active':'');
      el.innerHTML = `<div class="small muted">${d.toLocaleDateString(undefined,{weekday:'short'})}</div>
                      <div><strong>${d.getDate()}</strong></div>
                      <div class="small muted">${d.toLocaleDateString(undefined,{month:'short'})}</div>`;
      el.onclick = ()=>{ document.querySelectorAll('.day').forEach(x=>x.classList.remove('active')); el.classList.add('active'); activeDate=iso; loadDay(iso); };
      calendarEl.appendChild(el);
    }
  }

  /* ===== Firestore I/O ===== */
  async function dayRef(iso){ return doc(db,'users',uid,'days',iso); }
  async function ensureDay(iso){
    const ref = await dayRef(iso);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{ date:iso, points:0, tasks:{}, weekly:{ weekStart:weekStart(iso), weeklyPoints:0 }});
    }
    return ref;
  }
  async function recomputePoints(data){
    let pts = 0;
    // Meditation (required) if done ‚Üí add points
    if(data.tasks?.meditation?.done){ pts += (data.tasks.meditation.points||0); }
    // Smoothie (flat +2 when done)
    if(data.tasks?.smoothie_meal?.done){ pts += 2; }
    // Duration‚Äëbased movement
    for(const k of ['walk_DEBS','yoga','weights']){
      const t = data.tasks?.[k];
      if(t?.done){
        const p = pointsFromMinutes(Number(t.minutes||0));
        data.tasks[k].points = p; pts += p;
      }
    }
    data.points = pts; return data;
  }
  async function updateTask(iso, key, payload){
    const ref = await ensureDay(iso);
    const snap = await getDoc(ref);
    const data = snap.data() || {tasks:{}};
    data.tasks = data.tasks || {};
    data.tasks[key] = { ...(data.tasks[key]||{}), ...payload };
    await setDoc(ref, await recomputePoints(data), {merge:false});
    await updateWeekAgg(iso);
  }
  async function updateWeekAgg(iso){
    const ws = weekStart(iso);
    const q = query(collection(db,'users',uid,'days'), where('weekly.weekStart','==',ws));
    const snaps = await getDocs(q);
    let sum=0; snaps.forEach(s=> sum += (s.data().points||0));
    await Promise.all(snaps.docs.map(d=> updateDoc(d.ref, {'weekly.weekStart':ws,'weekly.weeklyPoints':sum})));
    renderWeek(ws,sum);
  }

  /* ===== Load a day (live) ===== */
  async function loadDay(iso){
    dayTitle.textContent = (iso===todayISO?'Today':new Date(iso+"T00:00:00").toLocaleDateString());
    if(unsubDay) unsubDay();
    const ref = await ensureDay(iso);
    unsubDay = onSnapshot(ref, snap=>{
      const data = snap.data() || {};
      weightInput.value = data.weight ?? '';
      // meditation status
      const med = data.tasks?.meditation;
      if(med?.done){ meditationStatus.textContent=`${med.type} ‚Ä¢ ${med.minutes} min ‚Ä¢ ${med.points} pts`; meditationReqNote.style.display='none'; }
      else { meditationStatus.textContent='Not logged yet'; meditationReqNote.style.display='inline'; }
      // tasks UI
      document.querySelectorAll('.task').forEach(t=>{
        const key = t.dataset.key;
        if(!key) return;
        if(key==='alcohol'){
          t.querySelector('.drinksInput').value = data.tasks?.alcohol?.drinks ?? '';
        } else if(['walk_DEBS','yoga','weights'].includes(key)){
          t.querySelector('.minutesInput').value = data.tasks?.[key]?.minutes ?? '';
          t.classList.toggle('done', !!data.tasks?.[key]?.done);
        } else {
          t.classList.toggle('done', !!data.tasks?.[key]?.done);
        }
      });
      dailyPointsEl.textContent = data.points || 0;
      refreshWeek(); // refresh header numbers
    });
  }

  /* ===== Handlers ===== */
  document.querySelectorAll('.completeBtn').forEach(btn=>{
    btn.onclick = async (e)=>{
      if(!uid) return alert('Tap Start (Guest) first');
      const wrap = e.target.closest('.task');
      const key = wrap.dataset.key; const iso = activeDate;
      if(['walk_DEBS','yoga','weights'].includes(key)){
        const mins = Number(wrap.querySelector('.minutesInput').value||0);
        await updateTask(iso, key, { done:true, minutes: mins });
      } else if(key==='smoothie_meal'){
        await updateTask(iso, key, { done:true });
      }
    };
  });

  document.querySelectorAll('.saveDrinksBtn').forEach(btn=>{
    btn.onclick = async (e)=>{
      if(!uid) return alert('Tap Start (Guest) first');
      const wrap = e.target.closest('.task'); const iso=activeDate;
      const drinks = Number(wrap.querySelector('.drinksInput').value||0);
      await updateTask(iso, 'alcohol', { drinks });
    };
  });

  document.getElementById('meditationDone').onclick = async ()=>{
    if(!uid) return alert('Tap Start (Guest) first');
    const iso = activeDate; const tag = meditationDuration.value;
    const pts = meditationPts(tag); const mins = tag==='lt15'?14: tag==='lt30'?29: 45;
    await updateTask(iso, 'meditation', { done:true, type:meditationType.value, minutes:mins, points:pts });
  };

  document.getElementById('saveWeight').onclick = async ()=>{
    if(!uid) return alert('Tap Start (Guest) first');
    const iso = activeDate; const ref = await ensureDay(iso);
    await setDoc(ref, { weight: Number(weightInput.value||0) }, { merge:true });
  };

  /* ===== Weekly view ===== */
  function daysLeftThisWeek(iso){
    const ws = new Date(weekStart(iso)+"T00:00:00");
    const td = new Date(todayISO+"T00:00:00");
    const idx = Math.min(6, Math.max(0, Math.floor((td-ws)/86400000))); // 0..6
    return 7 - (idx+1);
  }
  async function refreshWeek(){
    const ws = weekStart(todayISO);
    const q = query(collection(db,'users',uid||'x','days'), where('weekly.weekStart','==',ws));
    const snaps = await getDocs(q); let sum=0; snaps.forEach(s=> sum += (s.data().points||0));
    renderWeek(ws,sum);
  }
  function renderWeek(ws,total){
    wkRange.textContent = humanRange(ws);
    wkPoints.textContent = total;

    // Reward tiers
    const tiers = [
      {name:'üèÜ Elite', pts:90},
      {name:'‚≠ê High',  pts:80},
      {name:'üéØ Base',  pts:60}
    ];
    const next = tiers.find(t => total < t.pts) || null;

    if(!next){
      projLine.textContent = `You‚Äôre at üèÜ Elite or higher üéâ`;
      dailyNeed.textContent = '';
      return;
    }
    projLine.textContent = `Closest: ${next.name} @ ${next.pts} pts`;

    const left = daysLeftThisWeek(todayISO);
    const need = Math.max(0, next.pts - total);
    dailyNeed.textContent = left>0 ? `Need ~${Math.ceil(need/left)} pts/day for ${left} day(s)` : `Need ${need} pts today.`;
  }

  // Boot
  buildCalendar();
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
</script>
</body>
</html>
